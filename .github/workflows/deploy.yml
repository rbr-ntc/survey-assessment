name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
      FRONTEND_API_URL: ${{ secrets.FRONTEND_API_URL }}
      API_KEY: ${{ secrets.API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
      ENABLE_QUICK_TEST: ${{ secrets.ENABLE_QUICK_TEST }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-backend:${{ github.sha }},${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-backend:latest
          build-args: |
            CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
            ENABLE_QUICK_TEST=${{ secrets.ENABLE_QUICK_TEST }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./system-analyst-assessment
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-frontend:${{ github.sha }},${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.FRONTEND_API_URL }}
            NEXT_PUBLIC_API_KEY=${{ secrets.API_KEY }}
            NEXT_PUBLIC_ENABLE_QUICK_TEST=${{ secrets.ENABLE_QUICK_TEST }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            cd /opt/survey-assessment

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
            if docker compose ps | grep -q "Up"; then
              echo "Stopping existing containers..."
              docker compose down
            fi

            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð¼ÐµÑÑ‚Ð°
            docker image prune -f

            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ survey-assessment
            echo "Removing old survey-assessment images..."
            docker images | grep survey-assessment | awk '{print $3}' | xargs -r docker rmi -f || true

            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
            git pull origin main

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ production
            cat > .env << EOF
            MONGO_URL=mongodb://mongo:27017/assessment
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            API_KEY=${{ secrets.API_KEY }}
            CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
            EOF

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
            mkdir -p ssl

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¸Ð· GitHub Secrets
            if [ ! -z "${{ secrets.SSL_CERTIFICATE }}" ]; then
                echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¸Ð· GitHub Secrets..."
                echo "${{ secrets.SSL_CERTIFICATE }}" > ssl/fullchain.crt
                echo "${{ secrets.SSL_PRIVATE_KEY }}" > ssl/privkey.key
                
                # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
                chmod 600 ssl/privkey.key
                chmod 644 ssl/fullchain.crt
                chown root:root ssl/privkey.key ssl/fullchain.crt
                
                echo "âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸"
            else
                echo "âš ï¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² GitHub Secrets"
                echo "ðŸ’¡ Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ SSL_CERTIFICATE Ð¸ SSL_PRIVATE_KEY Ð² GitHub Secrets"
            fi

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.prod.yml Ð´Ð»Ñ production Ñ Nginx
            cat > docker-compose.prod.yml << EOF
            version: '3.8'

            services:
              nginx:
                image: nginx:alpine
                container_name: survey-assessment-nginx
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf
                  - ./ssl:/etc/nginx/ssl
                depends_on:
                  - frontend
                  - backend
                restart: unless-stopped
                networks:
                  - survey-network

              frontend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-frontend:latest
                container_name: survey-assessment-frontend
                environment:
                  - NODE_ENV=production
                  - NEXT_PUBLIC_API_URL=https://evaly.ru/api
                  - NEXT_PUBLIC_API_KEY=${{ secrets.API_KEY }}
                  - NEXT_PUBLIC_ENABLE_QUICK_TEST=${{ secrets.ENABLE_QUICK_TEST }}
                expose:
                  - "3000"
                restart: unless-stopped
                networks:
                  - survey-network

              backend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/survey-assessment-backend:latest
                container_name: survey-assessment-backend
                environment:
                  - CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
                  - OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
                  - API_KEY=${{ secrets.API_KEY }}
                  - ENABLE_QUICK_TEST=${{ secrets.ENABLE_QUICK_TEST }}
                expose:
                  - "8000"
                restart: unless-stopped
                networks:
                  - survey-network

              mongo:
                image: mongo:6
                container_name: survey-assessment-mongo
                environment:
                  - MONGO_INITDB_DATABASE=assessment
                volumes:
                  - mongo_data:/data/db
                  - ./mongo-init:/docker-entrypoint-initdb.d
                expose:
                  - "27017"
                restart: unless-stopped
                networks:
                  - survey-network

            volumes:
              mongo_data:

            networks:
              survey-network:
                driver: bridge
            EOF

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ MongoDB
            mkdir -p mongo-init

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
            cp backend/improved-test-questions.json mongo-init/

            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ HTTPS Ñ Nginx
            echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ HTTPS..."

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Nginx Ð¸ Certbot
            apt update -y
            apt install -y nginx certbot python3-certbot-nginx

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Nginx Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
            systemctl stop nginx

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx
            cp nginx.conf /etc/nginx/sites-available/survey-assessment
            ln -sf /etc/nginx/sites-available/survey-assessment /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
            nginx -t

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx
            systemctl start nginx
            systemctl enable nginx

            # ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð² firewall
            ufw allow 80
            ufw allow 443
            ufw allow 22
            ufw --force enable

            # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
            echo "ðŸ” Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚..."
            certbot --nginx -d evaly.ru -d www.evaly.ru --non-interactive --agree-tos --email admin@example.com

            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
            (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx
            systemctl reload nginx

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ MongoDB
            cat > mongo-init/init.js << EOF
            db = db.getSiblingDB('assessment');

            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ
            db.questions.drop();

            // Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
            const questions = JSON.parse(cat('/docker-entrypoint-initdb.d/improved-test-questions.json'));
            db.questions.insertMany(questions);

            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÑ‹
            db.questions.createIndex({ "id": 1 });
            db.questions.createIndex({ "category": 1 });

            print('MongoDB initialized successfully with ' + questions.length + ' questions');
            EOF

            # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            echo "Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð»Ð¸ÑÑŒ
            echo "Checking image timestamps..."
            docker images | grep survey-assessment

            # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼Ð¸
            echo "Starting containers with latest images..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° MongoDB
            echo "Waiting for MongoDB to start..."
            sleep 30

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            docker compose -f docker-compose.prod.yml ps

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼Ð¸
            echo "Checking container image versions..."
            docker compose -f docker-compose.prod.yml images

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB Ð¸ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
            echo "Checking MongoDB connection and importing questions..."
            docker exec survey-assessment-mongo-1 mongosh --eval "db.runCommand('ping')" assessment

            # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ (Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ init.js Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð»)
            echo "Forcing questions import..."
            docker exec survey-assessment-mongo-1 mongoimport --db assessment --collection questions --drop --file /docker-entrypoint-initdb.d/improved-test-questions.json --jsonArray

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²
            echo "Checking questions count..."
            docker exec survey-assessment-mongo-1 mongosh --eval "db.questions.countDocuments()" assessment

            echo "Deployment completed successfully!"
