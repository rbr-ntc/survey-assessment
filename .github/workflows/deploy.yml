name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: mistadrumma
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/mistadrumma/survey-assessment-backend:${{ github.sha }},ghcr.io/mistadrumma/survey-assessment-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./system-analyst-assessment
          push: true
          tags: ghcr.io/mistadrumma/survey-assessment-frontend:${{ github.sha }},ghcr.io/mistadrumma/survey-assessment-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Переходим в директорию проекта
            cd /opt/survey-assessment

            # Останавливаем существующие контейнеры если они запущены
            if docker compose ps | grep -q "Up"; then
              echo "Stopping existing containers..."
              docker compose down
            fi

            # Удаляем старые образы для экономии места
            docker image prune -f

            # Обновляем код
            git pull origin main

            # Создаем .env файл для production
            cat > .env << EOF
            MONGO_URL=mongodb://mongo:27017/assessment
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            API_KEY=${{ secrets.API_KEY }}
            EOF

            # Создаем docker-compose.prod.yml для production
            cat > docker-compose.prod.yml << EOF
            version: '3.8'

            services:
              mongo:
                image: mongo:6
                restart: always
                ports:
                  - "27017:27017"
                volumes:
                  - mongo_data:/data/db
                  - ./mongo-init:/docker-entrypoint-initdb.d
                
              backend:
                image: ghcr.io/mistadrumma/survey-assessment-backend:latest
                restart: always
                environment:
                  - MONGO_URL=mongodb://mongo:27017/assessment
                ports:
                  - "8000:8000"
                depends_on:
                  - mongo
                env_file:
                  - ./.env
                
              frontend:
                image: ghcr.io/mistadrumma/survey-assessment-frontend:latest
                restart: always
                environment:
                  - NEXT_PUBLIC_API_URL=http://${{ secrets.SERVER_HOST }}:8000
                ports:
                  - "3000:3000"
                depends_on:
                  - backend
                
            volumes:
              mongo_data:
            EOF

            # Создаем директорию для инициализации MongoDB
            mkdir -p mongo-init

            # Копируем вопросы в директорию инициализации
            cp backend/improved-test-questions.json mongo-init/

            # Создаем скрипт инициализации MongoDB
            cat > mongo-init/init.js << EOF
            db = db.getSiblingDB('assessment');

            // Удаляем существующую коллекцию
            db.questions.drop();

            // Импортируем вопросы
            const questions = JSON.parse(cat('/docker-entrypoint-initdb.d/improved-test-questions.json'));
            db.questions.insertMany(questions);

            // Создаем индексы
            db.questions.createIndex({ "id": 1 });
            db.questions.createIndex({ "category": 1 });

            print('MongoDB initialized successfully with ' + questions.length + ' questions');
            EOF

            # Запускаем контейнеры
            docker compose -f docker-compose.prod.yml up -d

            # Ждем запуска MongoDB
            echo "Waiting for MongoDB to start..."
            sleep 30

            # Проверяем статус
            docker compose -f docker-compose.prod.yml ps

            # Проверяем подключение к MongoDB
            docker exec survey-assessment-mongo-1 mongosh --eval "db.runCommand('ping')" assessment

            echo "Deployment completed successfully!"
